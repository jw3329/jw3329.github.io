---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Giscus from '../../components/Giscus.astro';
import { SITE } from '../../config';
import { getWritings, getWritingBySlug, renderMarkdown } from '../../lib/writings';

export async function getStaticPaths() {
  const writings = await getWritings();
  return writings.map((writing) => ({
    params: { slug: writing.slug },
    props: { slug: writing.slug },
  }));
}

const { slug } = Astro.props;
const writing = await getWritingBySlug(slug);

if (!writing) {
  return Astro.redirect('/writings/');
}

const htmlContent = renderMarkdown(writing.content);
const createdAt = new Date(writing.created_at);

const formattedDate = createdAt.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const wordCount = writing.content.trim().split(/\s+/).length;
const readTime = Math.max(1, Math.round(wordCount / 250));

const articleJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: writing.title,
  description: writing.description,
  datePublished: createdAt.toISOString(),
  wordCount,
  author: {
    '@type': 'Person',
    name: SITE.author,
    url: SITE.url,
  },
  publisher: {
    '@type': 'Person',
    name: SITE.author,
    url: SITE.url,
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': new URL(`/writings/${slug}/`, SITE.url).href,
  },
};

const breadcrumbJsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: SITE.url },
    { '@type': 'ListItem', position: 2, name: 'Writings', item: `${SITE.url}/writings/` },
    { '@type': 'ListItem', position: 3, name: writing.title, item: new URL(`/writings/${slug}/`, SITE.url).href },
  ],
};
---

<BaseLayout
  title={writing.title}
  description={writing.description}
  ogType="article"
  publishedDate={createdAt}
  articleCategory={writing.category}
  articleTags={writing.tags}
  jsonLd={[articleJsonLd, breadcrumbJsonLd]}
>
  <a href="/writings/" class="back-link">&larr; Back to writings</a>

  <article>
    <div class="article-header">
      <h1>{writing.title}</h1>
      <div class="writing-meta">
        <time datetime={createdAt.toISOString()}>{formattedDate}</time>
        <span class="meta-sep"></span>
        <span class="read-time">{readTime} min read</span>
        <span class="meta-sep"></span>
        <span class="tag accent">{writing.category}</span>
        {writing.tags && writing.tags.length > 0 && (
          <div class="writing-meta tags">
            {writing.tags.map((tag) => <span class="tag">{tag}</span>)}
          </div>
        )}
      </div>
    </div>

    <div class="prose" set:html={htmlContent} />
  </article>

  <Giscus />
</BaseLayout>
