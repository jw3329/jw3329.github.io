---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import ProjectCard from '../components/ProjectCard.astro';
import WritingCard from '../components/WritingCard.astro';
import { SITE } from '../config';
import { getWritings } from '../lib/writings';
import { getCollection } from 'astro:content';

const supabaseUrl = import.meta.env.SUPABASE_URL || '';
const supabaseKey = import.meta.env.SUPABASE_ANON_KEY || '';
const recentWritings = (await getWritings()).slice(0, 3);

const allProjects = (await getCollection('projects'))
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const featuredProjects = allProjects
  .filter((p) => p.data.featured && p.id !== 'tably' && p.id !== 'wisebuy')
  .slice(0, 4);

const homepageJsonLd = [
  {
    '@context': 'https://schema.org',
    '@type': 'WebSite',
    name: SITE.title,
    url: SITE.url,
    description: SITE.description,
    author: { '@type': 'Person', name: SITE.author, url: SITE.url },
  },
  {
    '@context': 'https://schema.org',
    '@type': 'Person',
    name: SITE.author,
    url: SITE.url,
    sameAs: [SITE.socials.github, SITE.socials.linkedin],
    jobTitle: 'Member of Technical Staff',
    worksFor: { '@type': 'Organization', name: 'CurieTech AI' },
  },
];
---

<BaseLayout title="Software Engineer, Builder & Writer" jsonLd={homepageJsonLd}>
  <Hero />

  <section class="products-section">
    <div class="section-header">
      <h2>Products</h2>
    </div>

    <div class="product-card">
      <div class="product-top">
        <div class="product-info">
          <div class="product-name-row">
            <h3>Moim</h3>
            <span class="product-badge">Cofounder & CTO</span>
          </div>
          <p class="product-desc">Event RSVP & management platform â€” guest tracking, Venmo payments, and social features for organizers.</p>
          <div class="tech-stack">
            <span class="tag">React</span>
            <span class="tag">TypeScript</span>
            <span class="tag">FastAPI</span>
            <span class="tag">Python</span>
          </div>
        </div>
        <div class="product-actions">
          <a href="https://www.mymoim.com" target="_blank" rel="noopener noreferrer" class="btn-live">Visit Site &nearr;</a>
          <a href="/projects/tably/" class="btn-details">Details &rarr;</a>
        </div>
      </div>
    </div>

    <div class="product-card">
      <div class="product-top">
        <div class="product-info">
          <div class="product-name-row">
            <h3>WiseBuy</h3>
            <span class="product-badge">Founder & Lead Engineer</span>
          </div>
          <p class="product-desc">Compare luxury brand prices across countries with real-time currency conversion, VAT refunds, and 15+ languages.</p>
          <div class="tech-stack">
            <span class="tag">Next.js</span>
            <span class="tag">TypeScript</span>
            <span class="tag">Vercel</span>
            <span class="tag">Serverless</span>
          </div>
        </div>
        <div class="product-actions">
          <a href="https://wisebuy-app.vercel.app" target="_blank" rel="noopener noreferrer" class="btn-live">Visit Site &nearr;</a>
          <a href="/projects/wisebuy/" class="btn-details">Details &rarr;</a>
        </div>
      </div>
    </div>
  </section>

  <section style="margin-top: 3rem;">
    <div class="section-header">
      <h2>Recent Writings</h2>
      <a href="/writings/">View all &rarr;</a>
    </div>
    <div
      id="recent-writings"
      data-supabase-url={supabaseUrl}
      data-supabase-key={supabaseKey}
    >
      {recentWritings.length > 0 ? (
        recentWritings.map((writing) => (
          <WritingCard
            title={writing.title}
            description={writing.description}
            date={new Date(writing.created_at)}
            category={writing.category}
            slug={writing.slug}
            tags={writing.tags}
          />
        ))
      ) : (
        <p style="color: var(--text-secondary);">Loading...</p>
      )}
    </div>
  </section>

  <section style="margin-top: 3rem;">
    <div class="section-header">
      <h2>Projects</h2>
      <a href="/projects/">View all &rarr;</a>
    </div>
    <div class="card-grid cols-2">
      {featuredProjects.map((project) => (
        <ProjectCard
          title={project.data.title}
          description={project.data.description}
          tech={project.data.tech}
          link={project.data.link}
          github={project.data.github}
          slug={project.id}
        />
      ))}
    </div>
  </section>
</BaseLayout>

<style>
  .products-section {
    margin-top: 2.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .product-card {
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    transition: all var(--transition);
    box-shadow: var(--card-shadow);
  }

  .product-card:hover {
    box-shadow: var(--card-shadow-hover);
    border-color: var(--accent);
  }

  .product-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1.5rem;
  }

  .product-info {
    flex: 1;
    min-width: 0;
  }

  .product-name-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .product-name-row h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--text);
    margin: 0;
  }

  .product-badge {
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent);
    background: var(--accent-light);
    padding: 0.2rem 0.55rem;
    border-radius: 9999px;
    white-space: nowrap;
  }

  .product-desc {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.55;
    margin-bottom: 0 !important;
  }

  .product-card .tech-stack {
    margin-top: 0.75rem;
  }

  .product-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex-shrink: 0;
    padding-top: 0.15rem;
  }

  .btn-live {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: #fff;
    background: var(--accent);
    padding: 0.45rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    transition: all var(--transition);
    white-space: nowrap;
  }

  .btn-live:hover {
    background: var(--accent-hover);
    color: #fff;
    transform: translateY(-1px);
  }

  .btn-details {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    transition: color var(--transition);
    white-space: nowrap;
  }

  .btn-details:hover {
    color: var(--accent);
  }

  @media (max-width: 640px) {
    .product-top {
      flex-direction: column;
      gap: 1rem;
    }

    .product-actions {
      flex-direction: row;
      width: 100%;
    }

    .btn-live {
      flex: 1;
    }

    .product-name-row {
      flex-wrap: wrap;
    }
  }

  .writing-card {
    display: block;
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--border);
    transition: all var(--transition);
    text-decoration: none;
  }

  .writing-card:hover {
    padding-left: 0.5rem;
  }

  .writing-card:hover h3 {
    color: var(--accent);
  }

  .writing-card .card-top {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .writing-card time {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }

  .writing-card h3 {
    font-size: 1.15rem;
    font-weight: 600;
    margin-bottom: 0.35rem;
    transition: color var(--transition);
    color: var(--text);
  }

  .writing-card p {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0;
    line-height: 1.5;
  }

  .writing-card .card-tags {
    display: flex;
    gap: 0.35rem;
    margin-top: 0.6rem;
  }
</style>

<script type="module" is:inline>
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  var container = document.getElementById('recent-writings');
  var url = container.dataset.supabaseUrl;
  var key = container.dataset.supabaseKey;

  if (!url || !key) {
    if (!container.querySelector('.writing-card')) {
      container.innerHTML = '<p style="color:var(--text-secondary)">Writings coming soon...</p>';
    }
  } else {
    var supabase = createClient(url, key);

    var resp = await supabase
      .from('writings')
      .select('*')
      .eq('draft', false)
      .order('created_at', { ascending: false })
      .limit(3);

    if (resp.error || !resp.data || resp.data.length === 0) {
      if (!container.querySelector('.writing-card')) {
        container.innerHTML = '<p style="color:var(--text-secondary)">Writings coming soon...</p>';
      }
    } else {
      container.innerHTML = resp.data.map(function (w) {
        var date = new Date(w.created_at);
        var formatted = date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        var tags = (w.tags || []).map(function (t) {
          return '<span class="tag">' + t + '</span>';
        }).join('');

        return '<a href="/writings/?slug=' + w.slug + '" class="writing-card">' +
          '<div class="card-top">' +
            '<time datetime="' + date.toISOString() + '">' + formatted + '</time>' +
            '<span class="tag accent">' + w.category + '</span>' +
          '</div>' +
          '<h3>' + w.title + '</h3>' +
          '<p>' + w.description + '</p>' +
          (tags ? '<div class="card-tags">' + tags + '</div>' : '') +
        '</a>';
      }).join('');
    }
  }
</script>
